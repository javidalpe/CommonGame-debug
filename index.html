<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-canvas-keyboard-response.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>
    const jsPsych = initJsPsych();
    var timeline = [];

    // control parameters
    n_trials = 12; 
    n_players_shown = 6;

    // generate initials to show to folks
    function generateRandomLetter() {
          const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          
          return alphabet[Math.floor(Math.random() * alphabet.length)]
        }

    function generatePlayers(n_trials){
        var all_players = [];

        while (all_players.length < n_trials * n_players_shown){
            var letter1 = generateRandomLetter();
            var letter2 = generateRandomLetter();

            all_players.push( letter1+letter2);
            all_players = [... new Set(all_players)];
        }

        return all_players;
    }   
    
    var players = generatePlayers(n_trials);
    var initials = [];  // needed for display

    // generate behaviors to show to folks
    /*
    strategy here is to generate lists of A and B behaviors - these determine what will be selected for participants
    for each set of A and B behaviors, numbers between 1 and 6, balanced - these determine how many of the selected behavior are also shown on that trial
    then use function to shuffle both in exactly same way
    */
    var trial_behavior = Array(n_trials/2).fill(["B"]).flat().concat(Array(n_trials/2).fill(["A"]).flat()); 
    var trial_n_behavior = Array(Math.ceil(n_trials/n_players_shown)).fill([1,2,3,4,5,6]).flat();

    //function to shuffle the image arrays in a way so blue and yellow arrays are shuffled the same//
        //the following block of 23 lines of code is copy and pasted from https://stackoverflow.com/questions/18194745/shuffle-multiple-javascript-arrays-in-the-same-way ! //
        function shuffle(array, array2) {
            var counter = array.length, temp, temp2, index;

             // "While there are elements in the array"
             while (counter > 0) {
                // "Pick a random index"
                //index = Math.floor(Math.random() * counter);
                index = Math.floor(Math.random() * counter);

                // "Decrease counter by 1"
                counter--;

                // "And swap the last element with it"
                temp = array[counter];
                temp2 = array2[counter];

                array[counter] = array[index];
                array2[counter] = array2[index];

                array[index] = temp;
                array2[index] = temp2;
            }
            return array;
        }   

    shuffle(trial_behavior, trial_n_behavior);

    function getAllIndexes(arr, val) {
        var indexes = [], i = -1;
        while ((i = arr.indexOf(val, i+1)) != -1){
            indexes.push(i);
        }
        return indexes;
    }

    // functions draw players and setup
    var coordinates = {
        x: [20, 20, 220, 220, 420, 420],
        y: [20, 260],
        w: 100,
        h: 100
    }

    var selected_behavior; //init
    var selected_behavior_pos;
    var n_selected;
    var behavior_list = [];

    function drawChoices(c, initials, behavior_list){
        // draws the box, initials and behaviors
        var ctx = c.getContext('2d');

        ctx.lineWidth = 3;
        ctx.font = "20px sans-serif";
        for (let i = 0; i <n_players_shown; i++){
            ctx.strokeRect(coordinates.x[i], coordinates.y[i % 2], coordinates.w, coordinates.h);
            ctx.fillText(initials[i], coordinates.x[i]+25, coordinates.y[i % 2]+ 50);            
            ctx.fillText(behavior_list[i], coordinates.x[i]+50, coordinates.y[i % 2] + coordinates.h + 40); 
        }
    }

    function drawChoiceRect(c, i){
        // draws rect around selected behavior [i]
        var ctx = c.getContext('2d');

        ctx.lineWidth = 5;
        ctx.strokeStyle = "#DD0000";
        ctx.strokeRect(coordinates.x[i]-7, coordinates.y[i % 2]- 7, coordinates.w + 13 , coordinates.h + 13)
    }

    // main trial loop
    const trial_main_fix = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<p style="font-size: 48px;">+</p>',
        choices: "NO_KEYS",
        trial_duration: 1000,
    };

    const trial_main_display = {
        type: jsPsychCanvasKeyboardResponse,
        canvas_size: [700, 700],
        stimulus: function(c){
            initials = players.splice(-n_players_shown, n_players_shown);
            
            // generate behaviors to view
            selected_behavior = trial_behavior.pop();
            n_selected = trial_n_behavior.pop();

            if (selected_behavior == "A"){
                //behavior_list = ["A" * ]
                behavior_list = Array(n_selected).fill(["A"]).flat().concat(Array(n_players_shown - n_selected).fill(["B"]).flat()); 
            } else {
                behavior_list = Array(n_selected).fill(["B"]).flat().concat(Array(n_players_shown - n_selected).fill(["A"]).flat()); 
            }

            jsPsych.randomization.repeat(behavior_list, 1)

            drawChoices(c, initials, behavior_list);
        },
        choices: "NO_KEYS",
        trial_duration: 2000
    };

    const trial_main_choose = {
        type: jsPsychCanvasKeyboardResponse,
        canvas_size: [700, 700],
        stimulus: function(c){
            var indexes = getAllIndexes(behavior_list, selected_behavior);
            console.log(indexes)

            selected_behavior = jsPsych.randomization.randomInt(0,5);  // which behaviour to highlight

            drawChoices(c, initials, behavior_list);
            drawChoiceRect(c, selected_behavior);
        },
        choices: ['f', 'j'],
        prompt: "<p> Press f or j </p> "
    };
    
    var procedure_main = {
        timeline: [trial_main_fix, trial_main_display, trial_main_choose],
        repetitions: n_trials
    };
    timeline.push(procedure_main);

    jsPsych.run(timeline);
  </script>
</html>
